#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

WEBAPP="pt-web/"
GENERAL="pt-general/"
PYTHON_BACKEND="br-general-python/"

# generateSwaggerDocs () {
#   pnpm swag
# }

# generateDbSchemas () {
#   pnpm db:generate
# }

preventUncommitedChanges () {
  # Check for uncommitted changes
  git diff --exit-code
  if [ $? -ne 0 ]; then
    echo "Changes detected after running swag. Please add the generated files before committing."
    exit 1
  fi
}

runWebappIfChanged () {
  if git diff --name-only --cached | grep "$WEBAPP"
  then
    echo "webapp changed. checking..."
    pnpm web:lint-staged
    pnpm concurrently \
        "pnpm web:type-check" \
        "pnpm web:test" \
        "pnpm web:build-storybook" \
        "pnpm web:build" \
        "pnpm web:cypress:component:run"
  fi
}

runGeneralIfChanged () {
  if git diff --name-only --cached | grep "$GENERAL"
  then
    echo "general changed. checking..."
    pnpm general:lint-staged
    pnpm concurrently \
        "pnpm general:type-check" \
        "pnpm general:test" \
        "pnpm general:build"
  fi
}

runPythonIfChanged () {
  if git diff --name-only --cached | grep "$PYTHON_BACKEND"
  then
    echo "Python backend changed. Running Ruff checks..."

    # Run Ruff check with auto-fix
    ruff check --fix --exit-non-zero-on-fix "$PYTHON_BACKEND"
    CHECK_EXIT=$?

    if [ $CHECK_EXIT -ne 0 ]; then
      echo "Ruff fixed issues or found errors. Please review changes and re-commit."
      git add "$PYTHON_BACKEND"
      exit 1
    fi

    # Format code with Ruff
    ruff format $PYTHON_BACKEND || {
      echo "Ruff formatting failed. Fix issues before committing."
      exit 1
    }

    # if auto-fixes were made, add the changes to the commit
    git add $PYTHON_BACKEND
  fi
}


# generateSwaggerDocs
# generateDbSchemas

runPythonIfChanged
preventUncommitedChanges

# integration and module tests
runWebappIfChanged
