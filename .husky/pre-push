#!/usr/bin/env bash
# Pre-push hook to block pushes to main and ensure tests pass.

SCRIPT_NAME="Pre-push Hook"
set -euo pipefail

# ----------------------------
# 1. Protect the main branch
# ----------------------------
BRANCH=$(git rev-parse --abbrev-ref HEAD)
PROTECTED_MAIN="main"

if [[ "$BRANCH" == "$PROTECTED_MAIN" ]]; then
  echo -e "\nðŸš« Error: Pushing directly to '$BRANCH' is not allowed."
  echo "ðŸ‘‰ Please create a feature branch and open a Pull Request instead.\n"
  exit 1
fi

echo -e "âœ… $SCRIPT_NAME: Branch name check passed.\n"

# ----------------------------
# 2. Run backend tests
# ----------------------------
echo "Running backend tests before push (br-general-python)..."
cd br-general-python || {
  echo "Could not change directory to br-general-python."
  exit 1
}

# Activate virtual environment if present
if [[ -d ".venv" ]]; then
  source .venv/bin/activate
else
  echo "No .venv found; assuming dependencies are available globally."
fi

# Run tests quietly but stop on first failure
pytest --maxfail=1 --disable-warnings -q
TEST_EXIT_CODE=$?

if [[ $TEST_EXIT_CODE -eq 0 ]]; then
  echo "All backend tests passed or skipped. Proceeding with push."
  exit 0
else
  echo "Tests failed. Push aborted."
  exit 1
fi